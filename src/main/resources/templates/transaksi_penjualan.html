<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaksi Penjualan - Sistem Manajemen Swalayan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link.active { background-color: #059669; color: white; } 
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .pagination-button {
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB;
            background-color: white;
            border-radius: 0.375rem;
            font-weight: 500;
            color: #374151;
            transition: background-color 0.2s;
        }
        .pagination-button:hover:not(:disabled) { background-color: #F9FAFB; }
        .pagination-button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <nav class="w-64 h-full bg-gray-900 text-white flex flex-col fixed">
            <div class="px-6 py-5 border-b border-gray-700">
                <div class="text-2xl font-bold">SWALAYAN SEGAR</div>
                <div id="user-display" class="text-m text-gray-200 mt-1 font-normal">Loading...</div>
            </div>
            <ul class="flex-1 py-4 space-y-2">
                <li style="display: none"><a href="/" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12A2.25 2.25 0 0 0 20.25 14.25V3m-16.5 0h16.5m-16.5 0v6.75A2.25 2.25 0 0 0 6 12h12a2.25 2.25 0 0 0 2.25-2.25V3" /></svg><span>Kasir</span></a></li>
                <li style="display: none"><a href="/transaksi_penjualan" class="flex items-center space-x-3 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg mx-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" /></svg><span>Transaksi Penjualan</span></a></li>
                <li style="display: none"><a href="/manajemen_stok" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg><span>Manajemen Stok</span></a></li>
                <li style="display: none"><a href="/transaksi_pembelian" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296A3.745 3.745 0 0 1 16.5 21a3.745 3.745 0 0 1-2.863-1.636A3.745 3.745 0 0 1 12 21a3.745 3.745 0 0 1-2.863-1.636A3.745 3.745 0 0 1 7.5 21a3.745 3.745 0 0 1-2.863-1.636A3.745 3.745 0 0 1 3 18.068A3.745 3.745 0 0 1 1.5 15c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296A3.745 3.745 0 0 1 7.5 3a3.745 3.745 0 0 1 2.863 1.636A3.745 3.745 0 0 1 12 3a3.745 3.745 0 0 1 16.5 3a3.745 3.745 0 0 1 2.863 1.636A3.745 3.745 0 0 1 21 5.932A3.745 3.745 0 0 1 22.5 9c0 1.268-.63 2.39-1.593 3.068A3.745 3.745 0 0 1 21 12Z" /></svg><span>Transaksi Pembelian</span></a></li>
                <li style="display: none"><a href="/stok_opname" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" /></svg><span>Stok Opname</span></a></li>
                <li style="display: none"><a href="/prediksi_stok" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg><span>Prediksi Stok</span></a></li>
                <li style="display: none"><a href="/laporan_keuangan" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125c-.621 0-1.125-.504-1.125-1.125v-6.75Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125v-6.75a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 6.375v6.75" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12c0-1.657-1.343-3-3-3s-3 1.343-3 3h6Z" /></svg><span>Laporan Keuangan</span></a></li>
                <li style="display: none"><a href="/manajemen_pengguna" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg><span>Pengguna</span></a></li>
            </ul>
            <div class="p-4 border-t border-gray-800 mt-auto">
                <a href="/logout" class="flex items-center space-x-3 px-6 py-3 text-red-400 hover:bg-gray-800 rounded-lg transition"><span>Keluar</span></a>
            </div>
        </nav>
        
        <main class="flex-1 p-6 md:p-8 overflow-y-auto ml-64">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Laporan Transaksi Penjualan</h1>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div class="flex items-center gap-2">
                         <input type="date" id="start-date" class="px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-green-500">
                         <span>-</span>
                         <input type="date" id="end-date" class="px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-green-500">
                    </div>
                    <input type="text" id="search-input" placeholder="Cari ID Transaksi..." class="w-full md:w-auto px-3 py-1.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-green-500">
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-3 font-semibold">ID Transaksi</th>
                                <th class="p-3 font-semibold">Tanggal</th>
                                <th class="p-3 font-semibold">Kasir</th>
                                <th class="p-3 font-semibold">Total</th>
                                <th class="p-3 font-semibold text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body">
                            <tr id="loading-row"><td colspan="5" class="p-6 text-center text-gray-500">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="p-4 flex items-center justify-between border-t border-gray-200">
                    <div><span id="page-info" class="text-sm text-gray-600">Menampilkan 0-0 dari 0</span></div>
                    <div class="flex space-x-2">
                        <button id="prev-button" class="pagination-button" disabled>Sebelumnya</button>
                        <button id="next-button" class="pagination-button" disabled>Berikutnya</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="detail-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg m-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                 <h3 id="modal-title" class="text-xl font-bold text-gray-800"></h3>
                 <button onclick="hideModal('detail-modal')" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 modal-backdrop items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                 <h3 class="text-xl font-bold text-gray-800">Edit Transaksi</h3>
                 <button onclick="hideModal('edit-modal')" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="max-h-[60vh] overflow-y-auto">
                <input type="hidden" id="edit-trx-id">
                
                <div class="flex gap-2 mb-4 bg-gray-50 p-3 rounded">
                    <input type="number" id="new-item-id" placeholder="ID Barang" class="w-24 px-2 py-1 border rounded">
                    <input type="number" id="new-item-qty" placeholder="Jml" value="1" class="w-16 px-2 py-1 border rounded">
                    <button onclick="addNewItemToEdit()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">Tambah Item</button>
                </div>

                <table class="w-full text-left mb-4">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-sm">Nama Barang</th>
                            <th class="p-2 text-sm w-20">Jumlah</th>
                            <th class="p-2 text-sm text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="edit-items-body"></tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4 border-t pt-4">
                <button onclick="hideModal('edit-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 mr-2">Batal</button>
                <button onclick="saveEditTransaction()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Simpan Perubahan</button>
            </div>
        </div>
    </div>
    
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden" onclick="hideMessage()">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 id="message-title" class="text-xl font-semibold text-red-600">Error</h3>
                <button onclick="hideMessage()" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            </div>
            <p id="message-body" class="text-gray-700"></p>
            <button onclick="hideMessage()" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg mt-6 hover:bg-green-700 transition-all">Tutup</button>
        </div>
    </div>
    
    <script>
    // Tampilkan nama user di sidebar
    fetch('/api/me').then(res => res.json()).then(user => { if(user) document.getElementById('user-display').textContent = `Halo, ${user.nama}`; });

    let currentEditItems = []; // Menyimpan item transaksi yang sedang diedit
    let allProducts = [];      // --- BARU: Menyimpan daftar semua produk untuk lookup nama ---

    document.addEventListener('DOMContentLoaded', () => {
        let currentOffset = 0;
        const itemsLimit = 15;
        let totalAvailableTransactions = 0;
        let debounceTimer;

        // --- LOAD MASTER DATA BARANG (Agar Nama Barang muncul saat tambah item) ---
        async function loadProducts() {
            try {
                const response = await fetch('/api/barang'); // Endpoint yang sudah ada di BarangController
                if (response.ok) {
                    allProducts = await response.json();
                    console.log("Master Barang dimuat:", allProducts.length);
                }
            } catch (error) {
                console.error("Gagal memuat data barang:", error);
            }
        }
        loadProducts(); // Panggil saat awal
        // -------------------------------------------------------------------------

        const salesTableBody = document.getElementById('sales-table-body');
        const loadingRow = document.getElementById('loading-row');
        const detailModal = document.getElementById('detail-modal');
        const editModal = document.getElementById('edit-modal');
        const searchInput = document.getElementById('search-input');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageInfo = document.getElementById('page-info');

        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const formatDateTime = (dateString) => new Date(dateString).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }).replace('pukul', ',');
        
        window.hideModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        };

        window.hideMessage = () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        };

        window.showMessage = (title, body, isError = true) => {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-title').className = isError ? "text-xl font-semibold text-red-600" : "text-xl font-semibold text-green-600";
            document.getElementById('message-body').textContent = body;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        };

        const fetchTransactions = async (offset) => {
            loadingRow.style.display = 'table-row';
            if (offset === 0) salesTableBody.innerHTML = '';
            salesTableBody.appendChild(loadingRow);

            const params = new URLSearchParams({ offset: offset, limit: itemsLimit });
            if (searchInput.value.trim()) params.append('search_id', searchInput.value.trim());
            if (startDateInput.value) params.append('start_date', startDateInput.value);
            if (endDateInput.value) params.append('end_date', endDateInput.value);

            try {
                const response = await fetch(`/api/transaksi_penjualan?${params.toString()}`);
                const data = await response.json();
                totalAvailableTransactions = data.totalAvailableTransactions;
                currentOffset = offset;
                renderTable(data.transactions);
                updatePaginationControls(offset, data.transactions.length);
            } catch (error) {
                loadingRow.style.display = 'none';
                salesTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Error: ${error.message}</td></tr>`;
            }
        };

        const renderTable = (transactions) => {
            loadingRow.style.display = 'none';
            salesTableBody.innerHTML = '';
            if (transactions.length === 0) {
                salesTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Tidak ada transaksi ditemukan.</td></tr>`;
                return;
            }
            transactions.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${sale.id_penjualan}</td>
                    <td class="p-3">${formatDateTime(sale.tanggal_penjualan)}</td>
                    <td class="p-3">${sale.nama_kasir}</td>
                    <td class="p-3">${formatCurrency(sale.total_harga)}</td>
                    <td class="p-3 text-center space-x-2">
                        <button onclick="showDetailModal(${sale.id_penjualan})" class="text-green-600 hover:underline font-medium">Detail</button>
                        <button onclick="showEditModal(${sale.id_penjualan})" class="text-blue-600 hover:underline font-medium">Edit</button>
                    </td>
                `;
                salesTableBody.appendChild(row);
            });
        };
        
        const updatePaginationControls = (offset, loadedCount) => {
            const startItem = totalAvailableTransactions > 0 ? offset + 1 : 0;
            const endItem = offset + loadedCount;
            pageInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalAvailableTransactions}`;
            prevButton.disabled = (offset === 0);
            nextButton.disabled = (endItem >= totalAvailableTransactions);
        };

        // --- Logic Detail Modal ---
        window.showDetailModal = async (id) => {
            const modalBody = document.getElementById('modal-body');
            document.getElementById('modal-title').textContent = `Detail Transaksi: ${id}`;
            modalBody.innerHTML = '<div class="text-center p-4">Memuat...</div>';
            detailModal.classList.remove('hidden'); detailModal.classList.add('flex');
            
            try {
                const res = await fetch(`/api/transaksi_detail/${id}`);
                const data = await res.json();
                let itemsHtml = data.items.map(item => `
                    <div class="flex justify-between text-gray-700"><span>${item.nama_barang} (x${item.jumlah})</span><span>${formatCurrency(item.subtotal)}</span></div>
                `).join('');
                modalBody.innerHTML = `
                    <div class="space-y-2"><p><strong>Kasir:</strong> ${data.header.nama_kasir}</p><p><strong>Tanggal:</strong> ${formatDateTime(data.header.tanggal_penjualan)}</p><hr class="my-3"><h4 class="font-semibold mb-2">Item:</h4><div class="space-y-1">${itemsHtml}</div><hr class="my-3"><div class="space-y-1 font-medium"><div class="flex justify-between text-lg font-bold"><span>Total:</span> <span>${formatCurrency(data.summary.total)}</span></div></div></div>
                `;
            } catch (error) { modalBody.innerHTML = `<div class="text-center text-red-500">${error.message}</div>`; }
        };

        // --- Logic Edit Modal ---
        window.showEditModal = async (id) => {
            document.getElementById('edit-trx-id').value = id;
            document.getElementById('edit-items-body').innerHTML = '<tr><td colspan="3" class="text-center">Memuat...</td></tr>';
            editModal.classList.remove('hidden'); editModal.classList.add('flex');

            try {
                const res = await fetch(`/api/transaksi_detail/${id}`);
                const data = await res.json();
                
                // Mapping data dari API (snake_case) ke internal object (camelCase)
                currentEditItems = data.items.map(i => ({
                    idBarang: i.id_barang || i.ID_BARANG, 
                    nama: i.nama_barang || i.NAMA_BARANG,
                    jumlah: i.jumlah || i.JUMLAH
                }));
                
                renderEditItems();
            } catch (err) { 
                console.error(err);
                alert("Gagal memuat data edit."); 
            }
        };

        window.renderEditItems = () => {
            const tbody = document.getElementById('edit-items-body');
            tbody.innerHTML = '';
            currentEditItems.forEach((item, index) => {
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-2 text-sm">${item.nama || 'ID: '+item.idBarang}</td>
                        <td class="p-2"><input type="number" value="${item.jumlah}" onchange="updateItemQty(${index}, this.value)" class="w-16 border rounded px-1 text-center"></td>
                        <td class="p-2 text-right"><button onclick="removeEditItem(${index})" class="text-red-500 hover:text-red-700">&times;</button></td>
                    </tr>
                `;
            });
        };

        window.updateItemQty = (index, val) => {
            const newVal = parseInt(val);
            if(newVal < 1) {
                alert("Jumlah minimal 1");
                renderEditItems(); // Reset tampilan
                return;
            }
            currentEditItems[index].jumlah = newVal;
        };

        window.removeEditItem = (index) => {
            currentEditItems.splice(index, 1);
            renderEditItems();
        };

        // --- PERBAIKAN UTAMA DI SINI ---
        window.addNewItemToEdit = () => {
            const idInput = document.getElementById('new-item-id');
            const qtyInput = document.getElementById('new-item-qty');
            
            const id = parseInt(idInput.value);
            const qty = parseInt(qtyInput.value);

            if(!id || !qty || qty < 1) return alert("Isi ID dan Jumlah dengan benar");
            
            // 1. Cek apakah barangnya ada di Master Data?
            // (Karena config property-naming-strategy=SNAKE_CASE, fieldnya adalah id_barang dan nama_barang)
            const product = allProducts.find(p => p.id_barang === id);

            if (!product) {
                alert(`Barang dengan ID ${id} tidak ditemukan di sistem!`);
                return;
            }

            // 2. Cek apakah sudah ada di list edit?
            const existIndex = currentEditItems.findIndex(i => i.idBarang === id);
            
            if(existIndex !== -1) {
                // Kalau sudah ada, tambah jumlahnya
                currentEditItems[existIndex].jumlah += qty;
            } else {
                // Kalau belum ada, masukkan (DENGAN NAMA YANG SUDAH DITEMUKAN)
                currentEditItems.push({ 
                    idBarang: id, 
                    nama: product.nama_barang, // Ambil nama dari master data
                    jumlah: qty 
                });
            }

            renderEditItems();
            
            // Reset input
            idInput.value = '';
            qtyInput.value = '1';
            idInput.focus();
        };

        window.saveEditTransaction = async () => {
            const id = document.getElementById('edit-trx-id').value;
            if(currentEditItems.length === 0) return alert("Transaksi tidak boleh kosong item");

            try {
                const res = await fetch(`/api/transaksi/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ items: currentEditItems })
                });
                const result = await res.json();
                if(result.success) {
                    hideModal('edit-modal');
                    showMessage("Sukses", "Transaksi berhasil diperbarui", false);
                    fetchTransactions(currentOffset);
                } else {
                    showMessage("Gagal", result.message || "Gagal update", true);
                }
            } catch(err) { 
                showMessage("Error", "Gagal menghubungi server", true);
            }
        };

        // Event Listeners
        prevButton.addEventListener('click', () => { if (currentOffset - itemsLimit >= 0) fetchTransactions(currentOffset - itemsLimit); });
        nextButton.addEventListener('click', () => { if (currentOffset + itemsLimit < totalAvailableTransactions) fetchTransactions(currentOffset + itemsLimit); });
        
        const triggerFetch = () => { currentOffset = 0; fetchTransactions(0); };
        searchInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(triggerFetch, 500); });
        startDateInput.addEventListener('change', triggerFetch);
        endDateInput.addEventListener('change', triggerFetch);

        fetchTransactions(currentOffset);
    });

    fetch('/api/me')
        .then(res => res.json())
        .then(user => {
            if(user) {
                document.getElementById('user-display').textContent = `Halo, ${user.nama} (${user.role})`;
                
                // Definisi Hak Akses sesuai Request Anda
                const role = user.role; // 'Kasir', 'Gudang', 'Owner', 'Supervisor'
                
                const menuItems = {
                    'Kasir': [
                        '/', 
                        '/manajemen_stok'
                    ],
                    'Gudang': [
                        '/stok_opname', 
                        '/manajemen_stok', 
                        '/prediksi_stok', 
                        '/transaksi_pembelian'
                    ],
                    'Owner': [
                        '/laporan_keuangan', 
                        '/manajemen_pengguna'
                    ],
                    'Supervisor': [
                        '/stok_opname', 
                        '/manajemen_stok', 
                        '/prediksi_stok', 
                        '/transaksi_pembelian', 
                        '/transaksi_penjualan', 
                        '/manajemen_pengguna'
                    ]
                };

                const allowed = menuItems[role] || [];
                
                // Logika BARU: Cari link, jika ada di daftar allowed, ubah display jadi block
                const links = document.querySelectorAll('nav ul li a');
                
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    // Cek apakah href ada di dalam daftar yang diizinkan
                    if (allowed.includes(href)) {
                        link.parentElement.style.display = 'block'; // Munculkan!
                    }
                });
            }
        })
        .catch(err => {
            console.error("Gagal cek sesi", err);
            window.location.href = '/login';
        });

</script>
</body>
</html>