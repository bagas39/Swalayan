<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Opname - Swalayan Segar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <nav class="w-64 h-full bg-gray-900 text-white flex flex-col fixed">
            <div class="px-6 py-5 border-b border-gray-700">
                <div class="text-2xl font-bold">SWALAYAN SEGAR</div>
                <div id="user-display" class="text-m text-gray-200 mt-1 font-normal">Loading...</div>
            </div>
            <ul class="flex-1 py-4 space-y-2">
                <li style="display: none">
                    <a href="/" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12A2.25 2.25 0 0 0 20.25 14.25V3m-16.5 0h16.5m-16.5 0v6.75A2.25 2.25 0 0 0 6 12h12a2.25 2.25 0 0 0 2.25-2.25V3" /></svg>
                        <span>Kasir</span>
                    </a>
                </li>
                <li style="display: none">
                    <a href="/transaksi_penjualan" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z" /></svg>
                        <span>Transaksi Penjualan</span>
                    </a>
                </li>
                <li style="display: none">
                    <a href="/manajemen_stok" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg>
                        <span>Manajemen Stok</span>
                    </a>
                </li>
                <li style="display: none">
                    <a href="/transaksi_pembelian" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296A3.745 3.745 0 0 1 16.5 21a3.745 3.745 0 0 1-2.863-1.636A3.745 3.745 0 0 1 12 21a3.745 3.745 0 0 1-2.863-1.636A3.745 3.745 0 0 1 7.5 21a3.745 3.745 0 0 1-2.863-1.636A3.745 3.745 0 0 1 3 18.068A3.745 3.745 0 0 1 1.5 15c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296A3.745 3.745 0 0 1 7.5 3a3.745 3.745 0 0 1 2.863 1.636A3.745 3.745 0 0 1 12 3a3.745 3.745 0 0 1 2.863 1.636A3.745 3.745 0 0 1 16.5 3a3.745 3.745 0 0 1 2.863 1.636A3.745 3.745 0 0 1 21 5.932A3.745 3.745 0 0 1 22.5 9c0 1.268-.63 2.39-1.593 3.068A3.745 3.745 0 0 1 21 12Z" /></svg>
                        <span>Transaksi Pembelian</span>
                    </a>
                </li>
                <li style="display: none">
                    <a href="/stok_opname" class="flex items-center space-x-3 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg mx-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" /></svg>
                        <span>Stok Opname</span>
                    </a>
                </li>
                 <li style="display: none">
                    <a href="/prediksi_stok" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>
                        <span>Prediksi Stok</span>
                    </a>
                </li>
                <li style="display: none">
                    <a href="/laporan_keuangan" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h15.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125H4.125c-.621 0-1.125-.504-1.125-1.125v-6.75Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125v-6.75a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 6.375v6.75" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12c0-1.657-1.343-3-3-3s-3 1.343-3 3h6Z" /></svg>
                        <span>Laporan Keuangan</span>
                    </a>
                </li>
                <li style="display: none">
                    <a href="/manajemen_pengguna" class="flex items-center space-x-3 px-6 py-3 text-gray-300 hover:bg-gray-700 rounded-lg mx-3 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" /></svg>
                        <span>Pengguna</span>
                    </a>
            </li>
            </ul>
            <div class="p-4 border-t border-gray-800 mt-auto">
                <a href="/logout" class="flex items-center space-x-3 px-6 py-3 text-red-400 hover:bg-gray-800 rounded-lg transition"><span>Keluar</span></a>
            </div>
        </nav>
        <main class="flex-1 ml-64 h-screen overflow-y-auto">
            <div class="p-8">
                <header class="mb-6"><h1 class="text-3xl font-bold text-gray-800">Stok Opname / Perhitungan Fisik Stok</h1></header>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <p class="mb-6 text-gray-600">Lakukan perhitungan fisik jumlah barang di rak, lalu masukkan hasilnya di kolom <strong>'Stok Fisik'</strong> untuk mencocokkan dengan data sistem.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Produk</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Produk</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Sistem</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Stok Fisik (Input)</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Selisih</th>
                                </tr>
                            </thead>
                            <tbody id="opname-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="mt-8 text-right">
                        <button id="save-opname-button" class="bg-green-600 text-white px-8 py-2.5 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-all duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">Simpan Hasil Opname</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
     <div id="alert-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm m-4">
            <h3 id="alert-title" class="text-xl font-bold text-gray-800"></h3>
            <p id="alert-message" class="text-gray-600 mt-2"></p>
            <div class="mt-6 text-right"><button id="alert-close-button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 font-semibold transition">Tutup</button></div>
        </div>
    </div>
    <script>
    fetch('/api/me').then(res => res.json()).then(user => { if(user) document.getElementById('user-display').textContent = `Halo, ${user.nama}`; });
    document.addEventListener('DOMContentLoaded', () => {
        const opnameTableBody = document.getElementById('opname-table-body');
        const saveOpnameButton = document.getElementById('save-opname-button');
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseButton = document.getElementById('alert-close-button');
        let opnameChanges = {};
        const showAlert = (title, message, type = 'success') => {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertTitle.className = "text-xl font-bold";
            if (type === 'error') { alertTitle.classList.add('text-red-600'); }
            else if (type === 'warning') { alertTitle.classList.add('text-yellow-600'); }
            else { alertTitle.classList.add('text-green-600'); }
            alertModal.classList.remove('hidden');
        };
        const hideAlert = () => { alertModal.classList.add('hidden'); };
        const renderTable = () => {
            opnameTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-500">Loading data dari server...</td></tr>';
            fetch('/api/barang').then(response => {
                if (!response.ok) { throw new Error('Gagal mengambil data produk (Status: ' + response.status + ')'); }
                return response.json();
            }).then(products => {
                opnameTableBody.innerHTML = '';
                if(products.length === 0) {
                    opnameTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-gray-500">Data barang kosong di Database.</td></tr>';
                    return;
                }
                products.forEach(p => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    const idProduk = p.idBarang || p.id || p.id_barang;
                    const namaProduk = p.namaBarang || p.name || p.nama_barang;
                    const stokSistem = p.stok || p.stock || 0;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${idProduk}</td> 
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${namaProduk}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-center font-semibold" data-stok-sistem="${stokSistem}">${stokSistem}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <input type="number" data-id="${idProduk}" class="stok-fisik-input w-24 text-center border border-gray-300 rounded-md py-1.5 focus:ring-2 focus:ring-green-500 focus:border-green-500 focus:outline-none transition shadow-sm" placeholder="${stokSistem}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center font-bold text-sm text-gray-400 selisih-stok">0</td>
                    `;
                    opnameTableBody.appendChild(row);
                });
            }).catch(error => {
                console.error('Error Fetch:', error);
                opnameTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-red-500 font-medium">Gagal mengambil data. Pastikan Spring Boot berjalan di port yang benar.</td></tr>';
            });
        };
        opnameTableBody.addEventListener('input', (e) => {
            if (e.target.classList.contains('stok-fisik-input')) {
                const input = e.target;
                const row = input.closest('tr');
                const selisihEl = row.querySelector('.selisih-stok');
                const stokSistem = parseInt(row.querySelector('[data-stok-sistem]').dataset.stokSistem);
                const val = input.value;
                const stokFisik = val === '' ? stokSistem : parseInt(val);
                const productId = input.dataset.id;
                if (val !== '' && stokFisik !== stokSistem) { opnameChanges[productId] = stokFisik; } else { delete opnameChanges[productId]; }
                if (!isNaN(stokSistem) && !isNaN(stokFisik)) {
                    const selisih = stokFisik - stokSistem;
                    if (selisih > 0) { selisihEl.textContent = '+' + selisih; selisihEl.className = 'px-6 py-4 whitespace-nowrap text-center font-bold text-sm text-green-600 selisih-stok'; }
                    else if (selisih < 0) { selisihEl.textContent = selisih; selisihEl.className = 'px-6 py-4 whitespace-nowrap text-center font-bold text-sm text-red-600 selisih-stok'; }
                    else { selisihEl.textContent = '0'; selisihEl.className = 'px-6 py-4 whitespace-nowrap text-center font-bold text-sm text-gray-400 selisih-stok'; }
                }
            }
        });
        saveOpnameButton.addEventListener('click', async () => {
            const keys = Object.keys(opnameChanges);
            if(keys.length === 0) { showAlert('Tidak Ada Perubahan', 'Anda belum memasukkan data stok fisik baru.', 'warning'); return; }
            const originalBtnText = saveOpnameButton.innerText;
            saveOpnameButton.disabled = true;
            saveOpnameButton.innerText = "Menyimpan ke SQL Server...";
            const promises = keys.map(async (productId) => {
                const stokFisikBaru = opnameChanges[productId];
                const row = document.querySelector(`input[data-id="${productId}"]`).closest('tr');
                const currentSystemStock = parseInt(row.querySelector('[data-stok-sistem]').dataset.stokSistem);
                const dataKirim = { idGudang: 1, idBarang: parseInt(productId), stokSistem: currentSystemStock, stokFisik: stokFisikBaru };
                try {
                    const response = await fetch('/api/opname', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataKirim) });
                    const text = await response.text();
                    let data;
                    try { data = text ? JSON.parse(text) : {}; } catch (e) { if (response.ok) data = { status: 'success' }; else throw new Error('Format respons server tidak valid: ' + text); }
                    if (!response.ok) { throw new Error(data.message || 'Server Error'); }
                    return { success: true, id: productId };
                } catch (error) {
                    console.error(`Gagal menyimpan ID ${productId}:`, error);
                    return { success: false, id: productId, error: error.message };
                }
            });
            const results = await Promise.allSettled(promises);
            const successes = results.filter(r => r.status === 'fulfilled' && r.value.success);
            const failures = results.filter(r => r.status === 'fulfilled' && !r.value.success);
            saveOpnameButton.disabled = false;
            saveOpnameButton.innerText = originalBtnText;
            if (failures.length === 0) { showAlert('Berhasil', `${successes.length} data stok opname berhasil disimpan!`, 'success'); opnameChanges = {}; renderTable(); }
            else if (successes.length > 0) { showAlert('Berhasil Sebagian', `${successes.length} tersimpan, ${failures.length} gagal. Cek log server.`, 'warning'); opnameChanges = {}; renderTable(); }
            else { showAlert('Gagal Menyimpan', 'Tidak ada data yang berhasil disimpan. Pastikan Controller /api/opname menerima method POST.', 'error'); }
        });
        alertCloseButton.addEventListener('click', hideAlert);
        renderTable();
    });
    fetch('/api/me').then(res => res.json()).then(user => {
            if(user) {
                document.getElementById('user-display').textContent = `Halo, ${user.nama} (${user.role})`;
                const role = user.role;
                const menuItems = {
                    'Kasir': ['/', '/manajemen_stok'],
                    'Gudang': ['/stok_opname', '/manajemen_stok', '/prediksi_stok', '/transaksi_pembelian'],
                    'Owner': ['/laporan_keuangan', '/manajemen_pengguna'],
                    'Supervisor': ['/stok_opname', '/manajemen_stok', '/prediksi_stok', '/transaksi_pembelian', '/transaksi_penjualan', '/manajemen_pengguna']
                };
                const allowed = menuItems[role] || [];
                const links = document.querySelectorAll('nav ul li a');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (allowed.includes(href)) { link.parentElement.style.display = 'block'; }
                });
            }
        }).catch(err => { console.error("Gagal cek sesi", err); window.location.href = '/login'; });
    </script>
</body>
</html>